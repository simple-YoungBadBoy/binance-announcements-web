<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Binance 公告历史</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 16px; background: #f5f5f5; }
    h1 { margin-top: 0; }
    #status { margin: 8px 0 16px; color: #666; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }
    th { background: #fafafa; text-align: left; }
    tr:hover { background: #f0f7ff; }
    .id-link { font-weight: 600; color: #0066cc; text-decoration: none; }
    .id-link:hover { text-decoration: underline; }
    .title { font-weight: 500; }
    .body-preview { color: #555; max-width: 600px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .highlight { outline: 2px solid #ff9800; background: #fff3e0 !important; }
    .controls { margin-bottom: 12px; font-size: 14px; }
    .controls input { padding: 4px 6px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Binance 公告历史</h1>
  <div id="status">正在加载数据...</div>

  <div class="controls">
    通过 ID 跳转：
    <input id="jumpInput" placeholder="例如：BN_01" />
    <button id="jumpBtn">跳转</button>
  </div>

  <!-- 详情容器：带 ?id=BN_xx 时只展示这一条 -->
  <div id="detail" style="display:none; margin-top: 16px;">
    <div style="margin-bottom: 8px; font-size: 14px;">
      <a id="backLink" href="./history.html">← 返回列表</a>
    </div>
    <div id="detail-id-line" style="font-size: 13px; color: #666;"></div>
    <h2 id="detail-title" style="margin: 8px 0;"></h2>
    <div id="detail-meta" style="font-size: 13px; color: #555; margin-bottom: 12px;"></div>
    <h3 style="margin: 8px 0 4px;">正文</h3>
    <pre id="detail-body" style="white-space: pre-wrap; background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #eee; font-size: 14px;"></pre>
    <div id="detail-disclaimer-wrap" style="margin-top: 12px; display: none;">
      <h3 style="margin: 8px 0 4px;">免责声明</h3>
      <pre id="detail-disclaimer" style="white-space: pre-wrap; background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #eee; font-size: 13px; color: #555;"></pre>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>发布时间</th>
        <th>分类</th>
        <th>标题</th>
        <th>内容预览</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>

  <script>
    function formatId(index) {
      const num = index + 1; // 从 1 开始
      return 'BN_' + String(num).padStart(2, '0');
    }

    function getQueryId() {
      const params = new URLSearchParams(window.location.search);
      const fromQuery = params.get('id');
      if (fromQuery) return fromQuery;
      if (window.location.hash) return window.location.hash.substring(1);
      return null;
    }

    function idToIndex(id) {
      if (!id) return -1;
      const upper = String(id).toUpperCase();
      const match = /^BN_(\d+)$/.exec(upper);
      if (!match) return -1;
      const num = parseInt(match[1], 10);
      if (!num || num < 1) return -1;
      return num - 1;
    }

    function renderDetail(item, id, totalCount) {
      const detail = document.getElementById('detail');
      const controls = document.querySelector('.controls');
      const table = document.querySelector('table');
      const status = document.getElementById('status');

      const ann = item.data || {};
      const publishTime = ann.publishDate ? new Date(ann.publishDate).toLocaleString() : '';
      const catalogName = ann.catalogName || '';

      const idLine = document.getElementById('detail-id-line');
      const titleEl = document.getElementById('detail-title');
      const metaEl = document.getElementById('detail-meta');
      const bodyEl = document.getElementById('detail-body');
      const disWrap = document.getElementById('detail-disclaimer-wrap');
      const disPre = document.getElementById('detail-disclaimer');

      if (idLine) {
        idLine.textContent = 'ID：' + id + '（共 ' + totalCount + ' 条）';
      }
      if (titleEl) {
        titleEl.textContent = ann.title || '';
      }

      let metaText = '';
      if (publishTime) metaText += '发布时间：' + publishTime;
      if (catalogName) {
        metaText += (metaText ? ' ｜ ' : '') + '分类：' + catalogName;
      }
      if (metaEl) {
        metaEl.textContent = metaText;
      }

      if (bodyEl) {
        bodyEl.textContent = ann.body || '';
      }

      const disclaimer = ann.disclaimer || '';
      if (disWrap && disPre) {
        if (disclaimer && disclaimer.trim()) {
          disPre.textContent = disclaimer;
          disWrap.style.display = 'block';
        } else {
          disWrap.style.display = 'none';
        }
      }

      const backLink = document.getElementById('backLink');
      if (backLink) {
        backLink.href = './history.html';
      }

      if (controls) controls.style.display = 'none';
      if (table) table.style.display = 'none';
      if (detail) detail.style.display = 'block';

      if (status) {
        status.textContent = '正在查看 ' + id + ' 的详情。';
      }
    }

    async function loadData() {
      const status = document.getElementById('status');
      const tbody = document.getElementById('list');
      if (status) {
        status.textContent = '正在从 logs/announcements_history.json 加载...';
      }

      try {
        const res = await fetch('./logs/announcements_history.json');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          if (status) {
            status.textContent = '暂无数据。请先运行监控程序生成 announcements_history.json。';
          }
          return;
        }

        const targetIdRaw = getQueryId();
        if (targetIdRaw) {
          const index = idToIndex(targetIdRaw);
          if (index >= 0 && index < data.length) {
            const normalizedId = formatId(index);
            renderDetail(data[index], normalizedId, data.length);
            return;
          } else if (status) {
            status.textContent = '未找到 ID 为 ' + targetIdRaw + ' 的公告，已展示全部列表。';
          }
        }

        if (tbody) {
          tbody.innerHTML = '';
        }

        data.forEach((item, index) => {
          const id = formatId(index);
          const ann = item.data || {};
          const tr = document.createElement('tr');
          tr.setAttribute('data-ann-id', id);

          const publishTime = ann.publishDate ? new Date(ann.publishDate).toLocaleString() : '';
          const bodyPreview = (ann.body || '').replace(/\s+/g, ' ').slice(0, 120);

          tr.innerHTML = `
            <td><a class="id-link" href="?id=${id}">${id}</a></td>
            <td>${publishTime}</td>
            <td>${ann.catalogName || ''}</td>
            <td class="title">${ann.title || ''}</td>
            <td class="body-preview" title="${(ann.body || '').replace(/"/g, '&quot;')}">${bodyPreview}</td>
          `;

          if (tbody) {
            tbody.appendChild(tr);
          }
        });

        if (status) {
          status.textContent = '共加载 ' + data.length + ' 条公告。ID 从 BN_01 开始自增。';
        }
      } catch (err) {
        console.error(err);
        if (status) {
          status.textContent = '加载失败：' + err.message + '。请确认在同一目录通过 HTTP 方式访问，并且存在 logs/announcements_history.json。';
        }
      }
    }

    document.getElementById('jumpBtn').addEventListener('click', () => {
      const input = document.getElementById('jumpInput');
      if (!input) return;
      const val = input.value.trim();
      if (!val) return;
      const index = idToIndex(val);
      if (index < 0) {
        alert('ID 格式不正确，请输入类似 BN_01');
        return;
      }
      const id = formatId(index);
      const url = new URL(window.location.href);
      url.searchParams.set('id', id);
      window.location.href = url.toString();
    });

    window.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>

